<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    
    <title>3D Periodic Table: Quantum Atom & Electron Simulation</title>

    <meta name="description" content="Explore the Probabilistic Superposition of electrons in a real-time 3D Periodic Table. This simulation solves the Schr√∂dinger Equation (ƒ§œà = Eœà) in real-time. The shapes you see are Spherical Harmonics, calculated on-the-fly to reveal the exact quantum geometry of nature, using Monte Carlo simulations of atomic orbitals.">

    <meta name="keywords" content="
        Proton, Electron, Quantum Periodic Table, 3D Atom Visualizer, Monte Carlo Simulation, 
        Electron Orbitals, Schrodinger Equation, Scrodinger, Schrodinger, Schroedinger, Schr√∂dinger, 
        Spherical Harmonics, Interactive Science,
        Hydrogen, Helium, Carbon, Nitrogen, Oxygen, Silicon, Iron, Copper, Gold, 
        Mercury, Thallium, Lead, Bismuth, Polonium, Astatine, Radon, Francium, Radium, 
        Actinium, Thorium, Protactinium, Uranium, Neptunium, Plutonium, Americium, Curium, 
        Berkelium, Californium, Einsteinium, Fermium, Mendelevium, Nobelium, Lawrencium, 
        Rutherfordium, Dubnium, Seaborgium, Bohrium, Hassium, Meitnerium, Darmstadtium, 
        Roentgenium, Copernicium, Nihonium, Flerovium, Moscovium, Livermorium, Tennessine, Oganesson
    ">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sapienza.dev/">
    <meta property="og:title" content="3D Periodic Table: Quantum Atom & Electron Simulation">
    <meta property="og:description" content="A real-time Monte Carlo simulation of atomic structure. Visualize the probabilistic superposition of electrons in 3D.">
    <meta property="og:image" content="https://sapienza.dev/img/screenshot_titanium.jpg">
    <meta name="twitter:image" content="https://sapienza.dev/img/screenshot_titanium.jpg">


    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Quantum Periodic Table",
      "operatingSystem": "Web Browser",
      "applicationCategory": "EducationalApplication",
      "offers": {
        "@type": "Offer",
        "price": "0.00",
        "priceCurrency": "USD"
      },
      "description": "A real-time Monte Carlo simulation of atomic structure, visualizing the probabilistic superposition of electrons in 3D.",
      "author": {
        "@type": "Person",
        "name": "Sapienza.dev"
      },
      "featureList": [
        "Real-time Schr√∂dinger Equation solver",
        "Interactive 3D visualization",
        "Monte Carlo integration",
        "Probability Density Function rendering",
        "Full Periodic Table support (Hydrogen to Oganesson)"
      ]
    }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; outline: none; }
        
       /* UI Styles */
        .ui-panel { 
            position: absolute; top: 20px; left: 20px; z-index: 100; 
            background: rgba(8, 8, 12, 0.92); padding: 20px; border-radius: 12px; border: 1px solid #333; 
            width: 340px; max-width: 90vw; box-shadow: 0 0 50px rgba(0,0,0,1); 
            backdrop-filter: blur(10px); max-height: 90vh; overflow-y: auto; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ui-panel.collapsed { height: 85px; overflow: hidden; background: rgba(8, 8, 12, 0.6); }
        .ui-panel.collapsed .controls-section { opacity: 0; pointer-events: none; }

        .toggle-btn {
            position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.2em; color: #aaa; transition: 0.2s;
        }
        .toggle-btn:hover { background: rgba(59, 130, 246, 0.5); color: #fff; }

        input[type="range"] { background: #111; height: 6px; -webkit-appearance: none; width: 100%; margin-top: 5px; border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid #fff; }
        
        .switch-container { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-toggle { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider-toggle:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-toggle { background-color: #3b82f6; }
        input:checked + .slider-toggle:before { transform: translateX(20px); }

        .btn { flex: 1; padding: 12px; background: #222; border: 1px solid #444; border-radius: 6px; color: #eee; font-size: 0.75em; font-weight: bold; cursor: pointer; transition: all 0.2s; text-align: center; letter-spacing: 0.05em; }
        .btn:hover { background: #333; color: #fff; border-color: #666; }
        .btn-active { background: #1e3a8a; border-color: #3b82f6; color: #fff; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        
        .element-badge { font-size: 3rem; font-weight: 800; text-align: center; margin-bottom: 2px; color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.4); line-height: 1; }
        .config-display { font-family: 'Courier New', monospace; color: #fbbf24; text-align: center; font-size: 0.9em; margin-bottom: 15px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 6px; word-wrap: break-word; line-height: 1.5; border: 1px solid #222; }
        .active-shell { color: #ffffff; font-weight: bold; text-shadow: 0 0 8px #ffffff; background: rgba(59, 130, 246, 0.6); padding: 1px 4px; border-radius: 3px; }
        
        .hud-footer { position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 50; }
        .hud-content { display: inline-block; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px; font-size: 0.75em; color: #aaa; border: 1px solid #333; backdrop-filter: blur(4px); pointer-events: auto; }
        .hud-icon { margin-right: 6px; color: #3b82f6; }
        
        .mobile-msg { display: none; }
        .desktop-msg { display: inline; }

        .help-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(20,20,30,0.9); border: 1px solid #444; border-radius: 50%; color: #fff; font-size: 1.2em; cursor: pointer; z-index: 100; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .help-btn:hover { background: #3b82f6; border-color: #3b82f6; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; backdrop-filter: blur(5px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0f0f12; padding: 30px; border-radius: 12px; border: 1px solid #333; width: 90%; max-width: 500px; color: #eee; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-title { font-size: 1.5em; font-weight: bold; color: #3b82f6; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .key-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9em; }
        .key-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }

        @media (max-width: 640px) {
            .ui-panel { left: 5%; width: 90%; top: 15px; }
            .help-btn { top: 15px; right: 5%; width: 35px; height: 35px; }
            .hud-content { font-size: 0.65em; padding: 6px 12px; max-width: 90%; }
            .element-badge { font-size: 2.2rem; }
            .mobile-msg { display: inline; }
            .desktop-msg { display: none; }
        }
    </style>
</head>
<body>
<div class="help-btn" onclick="toggleHelp()">?</div>
<div class="ui-panel" id="main-panel">
    <div class="toggle-btn" onclick="togglePanel()">&#9650;</div>

    <title class="element-badge">H</title>
    <h1 class="text-center text-sm text-gray-400 mb-1 tracking-widest uppercase" id="element-name">Hydrogen</h1> 
    
    <div class="controls-section">
        <div class="config-display" id="config-text">1s¬π</div>

        <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Atomic Number (Z)</label>
        <div class="flex items-center gap-3 mb-4">
            <span class="text-xl font-mono text-blue-500 w-8 font-bold" id="z-val">1</span>
            <input type="range" id="z-slider" min="1" max="118" value="1" step="1">
        </div>

        <div class="flex gap-2 mb-4">
            <button class="btn" id="play-btn">‚ñ∂ PLAY</button>
            <button class="btn" id="pause-btn">‚ùö‚ùö PAUSE</button>
            <button class="btn" id="reset-btn">‚Ü∫ RESET</button>
        </div>
        
        <div class="text-center text-[10px] text-gray-600 mb-4 border-t border-b border-gray-800 py-2">
            Max Z: 118 (Oganesson) ‚Ä¢ Lecture Speed: 1.2s
        </div>

        <div class="switch-container">
            <span class="text-sm font-bold text-gray-400">Plasma Bloom</span>
            <label class="switch"><input type="checkbox" id="bloom-toggle" checked><span class="slider-toggle"></span></label>
        </div>
        
        <div class="switch-container">
            <span class="text-sm font-bold text-gray-400">MRI Cross-Section</span>
            <label class="switch"><input type="checkbox" id="slice-toggle"><span class="slider-toggle"></span></label>
        </div>
    </div>
</div>

<div class="hud-footer">
    <div class="hud-content">
        <span class="desktop-msg">
            <span class="hud-icon">üñ±</span> Click & Drag to Rotate &nbsp;&nbsp;|&nbsp;&nbsp; 
            <span class="hud-icon">‚ö°</span> Scroll to Zoom &nbsp;&nbsp;|&nbsp;&nbsp; 
            <span class="hud-icon">‚úã</span> Right-Click to Pan
        </span>
        <span class="mobile-msg">
            <span class="hud-icon">üëÜ</span> Drag to Rotate &nbsp;|&nbsp; 
            <span class="hud-icon">‚úåÔ∏è</span> Pinch to Zoom
        </span>
    </div>
</div>

<div class="modal-overlay" id="info-modal" onclick="toggleHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-title">What am I looking at?</div>
        
        <p class="text-sm text-gray-400 mb-4 leading-relaxed">
            This is a <strong>Monte Carlo Simulation</strong> of atomic structure.
            The glowing clouds represent <strong>Probability Density Functions</strong> (|&psi;|<sup>2</sup>) ‚Äî regions where an electron is mathematically likely to be found.
        </p>
        
        <div class="font-bold text-gray-300 mb-2 text-xs uppercase tracking-wider">Shell Color Key</div>
        <div class="grid grid-cols-2 gap-2 mb-6">
            <div class="key-item"><div class="key-color" style="background:#ff0000; box-shadow:0 0 5px red"></div> n=1 (Red)</div>
            <div class="key-item"><div class="key-color" style="background:#ff8800; box-shadow:0 0 5px orange"></div> n=2 (Orange)</div>
            <div class="key-item"><div class="key-color" style="background:#ffff00; box-shadow:0 0 5px yellow"></div> n=3 (Yellow)</div>
            <div class="key-item"><div class="key-color" style="background:#00ff00; box-shadow:0 0 5px lime"></div> n=4 (Green)</div>
            <div class="key-item"><div class="key-color" style="background:#00ffff; box-shadow:0 0 5px cyan"></div> n=5 (Cyan)</div>
            <div class="key-item"><div class="key-color" style="background:#0000ff; box-shadow:0 0 5px blue"></div> n=6 (Blue)</div>
            <div class="key-item"><div class="key-color" style="background:#ff00ff; box-shadow:0 0 5px magenta"></div> n=7 (Violet)</div>
        </div>

        <div class="border-t border-gray-800 pt-4 mb-6">
            <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">The Physics Engine</div>
            <div class="flex gap-3">
                <div class="text-3xl text-gray-700">‚à´</div>
                <div>
                    <p class="text-xs text-gray-400 italic mb-1">
                        "The electron is not a planet; it is a standing wave."
                    </p>
                    <p class="text-xs text-gray-500 leading-snug">
                        This simulation solves the <strong>Schr√∂dinger Equation</strong> (<i>ƒ§&psi; = E&psi;</i>) in real-time. 
                        The shapes you see are <strong>Spherical Harmonics</strong>, calculated on-the-fly to reveal the exact quantum geometry of nature.
                    </p>
                </div>
            </div>
        </div>

        <button class="btn btn-active w-full" onclick="toggleHelp()">CLOSE INFO</button>
    </div>
</div>

<script>
    function toggleHelp() {
        const m = document.getElementById('info-modal');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function togglePanel() {
        const p = document.getElementById('main-panel');
        const btn = document.querySelector('.toggle-btn');
        p.classList.toggle('collapsed');
        btn.innerHTML = p.classList.contains('collapsed') ? '&#9660;' : '&#9650;';
    }

    // --- 1. SETUP ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.02);

    // CHANGED: Narrower FOV (45) to reduce "egg-shape" distortion
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 200);
    // CHANGED: Moved camera back (Z=40) to compensate for zoom
    camera.position.set(0, 5, 40);

    const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.localClippingEnabled = true;
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; 
    // CHANGED: Disabled camera auto-rotate to fix the pivot problem
    controls.autoRotate = false; 

    const renderScene = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.threshold=0; bloomPass.strength=1.3; bloomPass.radius=0.5;
    const composer = new THREE.EffectComposer(renderer);
    composer.addPass(renderScene); composer.addPass(bloomPass);

    function getSoftParticleTexture() {
        const c = document.createElement('canvas'); c.width=32; c.height=32;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(16,16,0,16,16,16);
        g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(0.5,'rgba(255,255,255,0.4)'); g.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
        return new THREE.CanvasTexture(c);
    }
    const particleSprite = getSoftParticleTexture();

    const atomGroup = new THREE.Group();
    const nucleusGroup = new THREE.Group();
    atomGroup.add(nucleusGroup);
    scene.add(atomGroup);
    
    const clipPlane = new THREE.Plane(new THREE.Vector3(-1, 0, 0), 0);

    // --- 2. DATA (Madelung) ---
    const aufbauOrder = [
        { n:1, t:'s', cap:2 },
        { n:2, t:'s', cap:2 }, { n:2, t:'p', cap:6 },
        { n:3, t:'s', cap:2 }, { n:3, t:'p', cap:6 },
        { n:4, t:'s', cap:2 }, { n:3, t:'d', cap:10 }, { n:4, t:'p', cap:6 },
        { n:5, t:'s', cap:2 }, { n:4, t:'d', cap:10 }, { n:5, t:'p', cap:6 },
        { n:6, t:'s', cap:2 }, { n:4, t:'f', cap:14 }, { n:5, t:'d', cap:10 }, { n:6, t:'p', cap:6 },
        { n:7, t:'s', cap:2 }, { n:5, t:'f', cap:14 }, { n:6, t:'d', cap:10 }, { n:7, t:'p', cap:6 }
    ];

    const elementSymbols = [
        "n/a", "H", "He", "Li", "Be", "B", "C", "N", "O", "F", "Ne", "Na", "Mg", "Al", "Si", "P", "S", "Cl", "Ar", "K", "Ca",
        "Sc", "Ti", "V", "Cr", "Mn", "Fe", "Co", "Ni", "Cu", "Zn", "Ga", "Ge", "As", "Se", "Br", "Kr", "Rb", "Sr", "Y", "Zr",
        "Nb", "Mo", "Tc", "Ru", "Rh", "Pd", "Ag", "Cd", "In", "Sn", "Sb", "Te", "I", "Xe", "Cs", "Ba", "La", "Ce", "Pr", "Nd",
        "Pm", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu", "Hf", "Ta", "W", "Re", "Os", "Ir", "Pt", "Au", "Hg",
        "Tl", "Pb", "Bi", "Po", "At", "Rn", "Fr", "Ra", "Ac", "Th", "Pa", "U", "Np", "Pu", "Am", "Cm", "Bk", "Cf", "Es", "Fm",
        "Md", "No", "Lr", "Rf", "Db", "Sg", "Bh", "Hs", "Mt", "Ds", "Rg", "Cn", "Nh", "Fl", "Mc", "Lv", "Ts", "Og"
    ];

    const elementNames = [
        "Vacuum", "Hydrogen", "Helium", "Lithium", "Beryllium", "Boron", "Carbon", "Nitrogen", "Oxygen", "Fluorine", "Neon",
        "Sodium", "Magnesium", "Aluminium", "Silicon", "Phosphorus", "Sulfur", "Chlorine", "Argon", "Potassium", "Calcium",
        "Scandium", "Titanium", "Vanadium", "Chromium", "Manganese", "Iron", "Cobalt", "Nickel", "Copper", "Zinc",
        "Gallium", "Germanium", "Arsenic", "Selenium", "Bromine", "Krypton", "Rubidium", "Strontium", "Yttrium", "Zirconium",
        "Niobium", "Molybdenum", "Technetium", "Ruthenium", "Rhodium", "Palladium", "Silver", "Cadmium", "Indium", "Tin",
        "Antimony", "Tellurium", "Iodine", "Xenon", "Cesium", "Barium", "Lanthanum", "Cerium", "Praseodymium", "Neodymium",
        "Promethium", "Samarium", "Europium", "Gadolinium", "Terbium", "Dysprosium", "Holmium", "Erbium", "Thulium", "Ytterbium",
        "Lutetium", "Hafnium", "Tantalum", "Tungsten", "Rhenium", "Osmium", "Iridium", "Platinum", "Gold", "Mercury",
        "Thallium", "Lead", "Bismuth", "Polonium", "Astatine", "Radon", "Francium", "Radium", "Actinium", "Thorium", "Protactinium",
        "Uranium", "Neptunium", "Plutonium", "Americium", "Curium", "Berkelium", "Californium", "Einsteinium", "Fermium",
        "Mendelevium", "Nobelium", "Lawrencium", "Rutherfordium", "Dubnium", "Seaborgium", "Bohrium", "Hassium", "Meitnerium",
        "Darmstadtium", "Roentgenium", "Copernicium", "Nihonium", "Flerovium", "Moscovium", "Livermorium", "Tennessine", "Oganesson"
    ];

    const shellColors = {
        1: new THREE.Color(0xff0000), 2: new THREE.Color(0xff8800), 3: new THREE.Color(0xffff00),
        4: new THREE.Color(0x00ff00), 5: new THREE.Color(0x00ffff), 6: new THREE.Color(0x0000ff),
        7: new THREE.Color(0xff00ff)
    };

    // --- 3. MATH ---
    const orbitals = {
        's': (t,p)=>1.0,
        'px': (t,p)=>Math.sin(t)*Math.cos(p), 'py': (t,p)=>Math.sin(t)*Math.sin(p), 'pz': (t,p)=>Math.cos(t),
        'dxy':(t,p)=>Math.sin(t)**2*Math.sin(2*p), 'dyz':(t,p)=>Math.sin(2*t)*Math.sin(p), 'dz2':(t,p)=>3*Math.cos(t)**2-1, 'dxz':(t,p)=>Math.sin(2*t)*Math.cos(p), 'dx2y2':(t,p)=>Math.sin(t)**2*Math.cos(2*p),
        'f1': (t,p)=>Math.sin(t)**3 * Math.cos(3*p),
        'f2': (t,p)=>Math.sin(t)**2 * Math.cos(t) * Math.sin(2*p),
        'f3': (t,p)=>(5*Math.cos(t)**3 - 3*Math.cos(t))
    };
    const p_list = ['px','py','pz'];
    const d_list = ['dxy','dyz','dz2','dxz','dx2y2'];
    const f_list = ['f1','f2','f3','f1','f2','f3','f1'];

    // --- 4. ENGINE ---
    
    function createNucleus(protons) {
        while(nucleusGroup.children.length>0) nucleusGroup.remove(nucleusGroup.children[0]);
        const neutrons = Math.round(protons * (1 + 0.006 * Math.pow(protons, 0.7)));
        const total = protons + neutrons;
        const geo = new THREE.SphereGeometry(0.2, 6, 6);
        const clip = document.getElementById('slice-toggle').checked ? [clipPlane] : [];
        const pMat = new THREE.MeshBasicMaterial({ color:0xff2222, clippingPlanes:clip });
        const nMat = new THREE.MeshBasicMaterial({ color:0x5555ff, clippingPlanes:clip });
        const count = protons > 80 ? Math.floor(total/2) : total; 

        for(let i=0; i<count; i++) {
            const phi = Math.acos(1 - 2*(i+0.5)/count);
            const theta = Math.PI*(1+Math.sqrt(5))*(i+0.5);
            const r = 0.35 * Math.pow(total, 1/3) * Math.random(); 
            const mesh = new THREE.Mesh(geo, Math.random()>0.45 ? pMat:nMat);
            mesh.position.set(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
            nucleusGroup.add(mesh);
        }
    }

    function createCloud(n, type, subIndex, eCount, totalElec) {
        const densityFactor = 3000 / Math.pow(totalElec, 0.85); 
        const count = Math.max(Math.floor(densityFactor * eCount), 200);
        
        const positions=[]; const colors=[];
        const baseC = shellColors[n] || new THREE.Color(0xffffff);
        
        let shapeFunc = orbitals['s'];
        if(type==='p') shapeFunc = orbitals[p_list[subIndex%3]];
        if(type==='d') shapeFunc = orbitals[d_list[subIndex%5]];
        if(type==='f') shapeFunc = orbitals[f_list[subIndex%7]];
        
        const radius = n * 2.2;

        for(let i=0; i<count; i++) {
            const u=Math.random(); const v=Math.random();
            const theta=Math.acos(2*u-1); const phi=2*Math.PI*v;
            const prob = Math.pow(Math.abs(shapeFunc(theta,phi)), 2);
            if(Math.random()>prob) { i--; continue; }
            
            const r = radius + ((Math.random()+Math.random()-1)*0.7);
            positions.push(r*Math.sin(theta)*Math.cos(phi), r*Math.sin(theta)*Math.sin(phi), r*Math.cos(theta));
            colors.push(baseC.r, baseC.g, baseC.b);
        }

        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(positions), 3));
        geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(colors), 3));
        
        const clip = document.getElementById('slice-toggle').checked ? [clipPlane] : [];
        const mat = new THREE.PointsMaterial({
            size: 0.3, map:particleSprite, vertexColors:true, transparent:true, opacity:0.3, 
            blending:THREE.AdditiveBlending, depthWrite:false, clippingPlanes:clip
        });
        return new THREE.Points(geo, mat);
    }

    function buildSystem(z) {
        const children = [];
        atomGroup.traverse(c => { if(c.isPoints) children.push(c); });
        children.forEach(c => atomGroup.remove(c));
        
        document.getElementById('big-sym').innerText = elementSymbols[z] || "??";
        document.getElementById('element-name').innerText = elementNames[z] || `Element ${z}`;
        document.getElementById('z-val').innerText = z;
        
        createNucleus(z);

        let electronsRemaining = z;
        let configHTML = "";
        
        for (let idx = 0; idx < aufbauOrder.length; idx++) {
            const subshell = aufbauOrder[idx];
            if (electronsRemaining <= 0) break;
            
            const fill = Math.min(electronsRemaining, subshell.cap);
            electronsRemaining -= fill;
            
            const isActive = (electronsRemaining === 0);
            if(isActive) {
                configHTML += `<span class="active-shell">${subshell.n}${subshell.t}<sup>${fill}</sup></span> `;
            } else {
                configHTML += `${subshell.n}${subshell.t}<sup>${fill}</sup> `;
            }

            let subCount = (subshell.t==='f')?7:(subshell.t==='d')?5:(subshell.t==='p')?3:1;
            for(let i=0; i<subCount; i++) {
                const eInSub = Math.ceil(fill/subCount);
                if(fill > 0) atomGroup.add(createCloud(subshell.n, subshell.t, i, eInSub, z));
            }
        }
        document.getElementById('config-text').innerHTML = configHTML;
    }

    // --- 5. ANIMATION LOGIC ---
    let playInterval = null;

    function stopSequence() {
        clearInterval(playInterval);
        playInterval = null;
        document.getElementById('play-btn').classList.remove('btn-active');
        document.getElementById('pause-btn').classList.add('btn-active');
    }

    function startSequence() {
        if(playInterval) return;
        document.getElementById('pause-btn').classList.remove('btn-active');
        document.getElementById('play-btn').classList.add('btn-active');
        
        playInterval = setInterval(() => {
            let z = parseInt(document.getElementById('z-slider').value);
            if (z >= 118) { stopSequence(); return; }
            z++;
            document.getElementById('z-slider').value = z;
            buildSystem(z);
        }, 1200); 
    }

    document.getElementById('z-slider').addEventListener('input', (e) => { 
        stopSequence(); document.getElementById('pause-btn').classList.remove('btn-active');
        buildSystem(parseInt(e.target.value)); 
    });

    document.getElementById('play-btn').addEventListener('click', startSequence);
    document.getElementById('pause-btn').addEventListener('click', stopSequence);
    document.getElementById('reset-btn').addEventListener('click', () => { 
        stopSequence(); document.getElementById('pause-btn').classList.remove('btn-active');
        document.getElementById('z-slider').value = 1; buildSystem(1); 
    });

    document.getElementById('slice-toggle').addEventListener('change', () => buildSystem(parseInt(document.getElementById('z-slider').value)));
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        // CHANGED: Rotate the GROUP instead of the CAMERA
        // This ensures the atom pivots around its own center, even if you pan the camera away.
        atomGroup.rotation.y -= 0.002; 

        if(document.getElementById('bloom-toggle').checked) composer.render(); else renderer.render(scene, camera);
    }
    
    buildSystem(1);
    animate();

</script>
</body>
</html>







